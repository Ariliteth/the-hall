name: Sync Registry

on:
  push:
    paths:
      - 'neighborhoods/**'
      - 'registry.json'

jobs:
  sync-registry:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Sync registry.json from neighborhoods directory
        run: |
          python3 << 'EOF'
          import json
          import os
          from pathlib import Path

          neighborhoods_dir = Path("neighborhoods")
          registry_path = Path("registry.json")

          if registry_path.exists():
              with open(registry_path) as f:
                  registry = json.load(f)
          else:
              registry = {"neighborhoods": {}}

          neighborhoods = registry.setdefault("neighborhoods", {})

          if neighborhoods_dir.exists():
              for neighborhood_dir in sorted(neighborhoods_dir.iterdir()):
                  if not neighborhood_dir.is_dir():
                      continue
                  slug = neighborhood_dir.name

                  if slug not in neighborhoods:
                      neighborhoods[slug] = {"entities": [], "theme": None, "scores": []}
                  entry = neighborhoods[slug]
                  entry.setdefault("entities", [])
                  entry.setdefault("theme", None)
                  entry.setdefault("scores", [])

                  entities_dir = neighborhood_dir / "entities"
                  if entities_dir.exists():
                      found = sorted([
                          d.name for d in entities_dir.iterdir()
                          if d.is_dir() and (d / "tuning.md").exists()
                      ])
                      new_arrivals = [e for e in found if e not in entry["entities"]]
                      if new_arrivals:
                          print(f"New entities in {slug}: {new_arrivals}")
                      entry["entities"] = entry["entities"] + new_arrivals
                      entry["entities"] = [
                          e for e in entry["entities"]
                          if (entities_dir / e).is_dir()
                      ]

                  theme_dir = neighborhood_dir / "theme"
                  if theme_dir.exists() and (theme_dir / "tuning.md").exists():
                      if entry["theme"] is None:
                          print(f"Theme found in {slug}")
                      entry["theme"] = slug
                  else:
                      entry["theme"] = None

                  scores_dir = neighborhood_dir / "scores"
                  if scores_dir.exists():
                      found_scores = sorted([
                          d.name for d in scores_dir.iterdir()
                          if d.is_dir() and any(d.iterdir())
                      ])
                      new_scores = [s for s in found_scores if s not in entry["scores"]]
                      if new_scores:
                          print(f"New scores in {slug}: {new_scores}")
                      entry["scores"] = entry["scores"] + new_scores
                      entry["scores"] = [
                          s for s in entry["scores"]
                          if (scores_dir / s).is_dir()
                      ]

              for slug in list(neighborhoods.keys()):
                  if not (neighborhoods_dir / slug).is_dir():
                      print(f"Neighborhood removed: {slug}")
                      del neighborhoods[slug]

          with open(registry_path, "w") as f:
              json.dump(registry, f, indent=2)
              f.write("\n")

          print("Registry synced.")
          print(json.dumps(registry, indent=2))
          EOF

      - name: Commit updated registry if changed
        run: |
          git config user.name "the-hall-registry"
          git config user.email "registry@fixedpointlocal"
          git add registry.json
          if git diff --staged --quiet; then
            echo "Registry already current. Nothing to commit."
          else
            git commit -m "Auto-sync registry from neighborhoods directory"
            git push
          fi
