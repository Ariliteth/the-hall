<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FIXED POINT LOCAL</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Share+Tech+Mono&family=Playfair+Display:ital@0;1&display=swap');

  :root {
    --void: #0a0806;
    --deep: #120f0a;
    --mud: #1e1710;
    --bark: #3d2e18;
    --warm: #5c4020;
    --amber: #c8820a;
    --gold: #e8b84b;
    --bone: #d4c8a8;
    --parchment: #ede0c0;
    --static: rgba(255,255,255,0.03);
    --signal: #e8b84b;
    --hub-height: 100vh;
    --score-frame-display: none;
    --selection-display: block;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  html, body {
    height: 100%;
    background: var(--void);
    font-family: 'Share Tech Mono', monospace;
    color: var(--bone);
    overflow-x: hidden;
  }

  /* CRT scanline overlay */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background: repeating-linear-gradient(
      0deg,
      transparent,
      transparent 2px,
      rgba(0,0,0,0.08) 2px,
      rgba(0,0,0,0.08) 4px
    );
    pointer-events: none;
    z-index: 1000;
  }

  /* Vignette */
  body::after {
    content: '';
    position: fixed;
    inset: 0;
    background: radial-gradient(ellipse at center, transparent 50%, rgba(0,0,0,0.7) 100%);
    pointer-events: none;
    z-index: 999;
  }

  /* ── SIGNAL BAR ── */
  #signal-bar {
    width: 100%;
    background: var(--amber);
    padding: 3px 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.55rem;
    letter-spacing: 3px;
    text-transform: uppercase;
    color: var(--void);
    font-weight: bold;
    position: relative;
    z-index: 50;
    flex-shrink: 0;
  }

  #signal-bar .dot {
    width: 5px; height: 5px;
    border-radius: 50%;
    background: var(--void);
    display: inline-block;
    margin-right: 6px;
    animation: pulse 2s ease infinite;
  }

  /* ── HUB SHELL — full height flex column ── */
  #hub-shell {
    display: flex;
    flex-direction: column;
    height: 100vh;
    position: relative;
    z-index: 10;
  }

  /* ── SELECTION PANEL ── */
  #selection-panel {
    flex: 1;
    overflow-y: auto;
    transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1),
                opacity 0.3s ease;
    max-height: 100vh;
    opacity: 1;
  }

  #selection-panel.collapsed {
    max-height: 0;
    opacity: 0;
    overflow: hidden;
    pointer-events: none;
  }

  /* ── SCORE FRAME AREA ── */
  #score-area {
    display: none;
    flex: 1;
    position: relative;
    min-height: 0;
  }

  #score-area.active {
    display: flex;
    flex-direction: column;
  }

  #score-frame {
    width: 100%;
    flex: 1;
    border: none;
    background: var(--void);
    min-height: 0;
  }

  /* ── HUD BAR — shown when score is running ── */
  #hud-bar {
    display: none;
    align-items: center;
    gap: 16px;
    padding: 5px 16px;
    background: var(--mud);
    border-bottom: 1px solid var(--bark);
    font-size: 0.55rem;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--warm);
    flex-shrink: 0;
    position: relative;
    z-index: 50;
  }

  #hud-bar.visible {
    display: flex;
  }

  #hud-score-name {
    color: var(--amber);
    flex: 1;
  }

  #hud-scraggle-feed {
    display: flex;
    gap: 8px;
    align-items: center;
    overflow: hidden;
    max-width: 300px;
  }

  .hud-scraggle {
    font-size: 0.9rem;
    animation: scraggle-arrive 0.4s ease;
    cursor: default;
  }

  @keyframes scraggle-arrive {
    from { opacity: 0; transform: translateY(-4px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  #hud-eject {
    background: none;
    border: 1px solid var(--bark);
    color: var(--warm);
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.5rem;
    letter-spacing: 2px;
    text-transform: uppercase;
    padding: 3px 8px;
    cursor: pointer;
    transition: all 0.1s;
  }

  #hud-eject:hover {
    border-color: var(--amber);
    color: var(--amber);
  }

  /* ── STAGE ── */
  #stage {
    max-width: 860px;
    margin: 0 auto;
    padding: 0 24px 60px;
  }

  /* ── MASTHEAD ── */
  #masthead {
    padding: 32px 0 24px;
    border-bottom: 1px solid var(--bark);
    margin-bottom: 32px;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  #channel-tag {
    font-size: 0.6rem;
    letter-spacing: 4px;
    text-transform: uppercase;
    color: var(--amber);
    opacity: 0.8;
  }

  #title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: clamp(3rem, 8vw, 5.5rem);
    letter-spacing: 8px;
    color: var(--parchment);
    line-height: 0.9;
    text-shadow: 4px 4px 0 rgba(0,0,0,0.6);
  }

  #title span { color: var(--amber); }

  #subtitle {
    font-family: 'Playfair Display', serif;
    font-style: italic;
    font-size: 0.85rem;
    color: var(--warm);
    letter-spacing: 1px;
    margin-top: 4px;
  }

  #status-line {
    font-size: 0.6rem;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--bark);
    display: flex;
    gap: 24px;
    align-items: center;
    margin-top: 12px;
  }

  #status-line .dot {
    width: 6px; height: 6px;
    border-radius: 50%;
    background: var(--amber);
    display: inline-block;
    margin-right: 6px;
    animation: pulse 2s ease infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
  }

  /* ── TWO COLUMN LAYOUT ── */
  #columns {
    display: grid;
    grid-template-columns: 1fr 280px;
    gap: 32px;
    align-items: start;
  }

  /* ── SCORE RACK ── */
  #rack-section h2 {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 0.9rem;
    letter-spacing: 4px;
    color: var(--amber);
    margin-bottom: 16px;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--bark);
  }

  #score-rack {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .score-card {
    background: var(--deep);
    border: 1px solid var(--bark);
    border-left: 3px solid var(--bark);
    padding: 14px 16px;
    cursor: pointer;
    transition: all 0.15s;
    position: relative;
    overflow: hidden;
  }

  .score-card::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(90deg, rgba(200,130,10,0.05) 0%, transparent 60%);
    opacity: 0;
    transition: opacity 0.2s;
  }

  .score-card:hover::before,
  .score-card.selected::before { opacity: 1; }

  .score-card:hover,
  .score-card.selected {
    border-left-color: var(--amber);
    border-color: var(--warm);
  }

  .score-card.selected { background: var(--mud); }

  .score-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.3rem;
    letter-spacing: 3px;
    color: var(--parchment);
    line-height: 1;
    margin-bottom: 4px;
  }

  .score-card.selected .score-title { color: var(--gold); }

  .score-desc {
    font-size: 0.65rem;
    color: var(--warm);
    letter-spacing: 1px;
    line-height: 1.6;
  }

  .score-meta {
    display: flex;
    gap: 12px;
    margin-top: 8px;
  }

  .score-tag {
    font-size: 0.5rem;
    letter-spacing: 2px;
    text-transform: uppercase;
    padding: 2px 6px;
    border: 1px solid var(--bark);
    color: var(--bark);
  }

  .score-card.selected .score-tag {
    border-color: var(--warm);
    color: var(--warm);
  }

  .score-card.soon {
    opacity: 0.4;
    cursor: default;
    pointer-events: none;
  }

  /* ── SIDEBAR ── */
  #sidebar {
    display: flex;
    flex-direction: column;
    gap: 24px;
  }

  .sidebar-block {
    border: 1px solid var(--bark);
    background: var(--deep);
  }

  .sidebar-block h3 {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 0.8rem;
    letter-spacing: 3px;
    color: var(--amber);
    padding: 8px 12px;
    border-bottom: 1px solid var(--bark);
    background: var(--mud);
  }

  /* ── NEIGHBORHOOD FILTER ── */
  #neighborhood-list { padding: 8px 0; }

  .neighborhood-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 7px 12px;
    cursor: pointer;
    transition: background 0.1s;
    font-size: 0.65rem;
    letter-spacing: 1px;
  }

  .neighborhood-item:hover { background: var(--mud); }

  .neighborhood-item input[type="checkbox"] {
    appearance: none;
    width: 12px; height: 12px;
    border: 1px solid var(--bark);
    background: var(--void);
    cursor: pointer;
    flex-shrink: 0;
    position: relative;
    transition: all 0.1s;
  }

  .neighborhood-item input[type="checkbox"]:checked {
    background: var(--amber);
    border-color: var(--amber);
  }

  .neighborhood-item input[type="checkbox"]:checked::after {
    content: '';
    position: absolute;
    inset: 2px;
    background: var(--void);
    clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%);
  }

  .neighborhood-name { flex: 1; color: var(--bone); }

  .neighborhood-count {
    font-size: 0.55rem;
    color: var(--bark);
    letter-spacing: 1px;
  }

  /* ── THEME SELECTOR ── */
  #theme-list { padding: 8px 0; }

  .theme-item {
    display: flex;
    align-items: flex-start;
    gap: 10px;
    padding: 7px 12px;
    cursor: pointer;
    transition: background 0.1s;
  }

  .theme-item:hover { background: var(--mud); }

  .theme-item input[type="checkbox"] {
    appearance: none;
    width: 12px; height: 12px;
    border: 1px solid var(--bark);
    background: var(--void);
    cursor: pointer;
    flex-shrink: 0;
    margin-top: 2px;
    position: relative;
    transition: all 0.1s;
  }

  .theme-item input[type="checkbox"]:checked {
    background: var(--amber);
    border-color: var(--amber);
  }

  .theme-item input[type="checkbox"]:checked::after {
    content: '';
    position: absolute;
    inset: 2px;
    background: var(--void);
    clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%);
  }

  .theme-info { flex: 1; }

  .theme-name {
    font-size: 0.65rem;
    letter-spacing: 1px;
    color: var(--bone);
    line-height: 1.4;
  }

  .theme-desc {
    font-size: 0.55rem;
    color: var(--bark);
    letter-spacing: 0.5px;
    margin-top: 2px;
    line-height: 1.5;
  }

  /* ── ROSTER PREVIEW ── */
  #roster-preview {
    padding: 10px 12px;
    min-height: 60px;
  }

  .roster-entry {
    font-size: 0.6rem;
    letter-spacing: 1px;
    color: var(--warm);
    line-height: 2;
    display: flex;
    justify-content: space-between;
  }

  .roster-entry .hood {
    color: var(--bark);
    font-size: 0.5rem;
  }

  #roster-loading {
    font-size: 0.6rem;
    color: var(--bark);
    letter-spacing: 2px;
    animation: blink 1s step-end infinite;
  }

  @keyframes blink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0; }
  }

  /* ── LAUNCH ── */
  #launch-section {
    margin-top: 32px;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  #context-summary {
    font-size: 0.6rem;
    letter-spacing: 1px;
    color: var(--warm);
    line-height: 1.8;
    padding: 12px 16px;
    border: 1px solid var(--bark);
    background: var(--deep);
    min-height: 48px;
  }

  #launch-btn {
    background: var(--amber);
    border: none;
    border-bottom: 4px solid rgba(0,0,0,0.4);
    color: var(--void);
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.6rem;
    letter-spacing: 6px;
    padding: 14px 40px;
    cursor: pointer;
    transition: all 0.1s;
    align-self: flex-start;
    position: relative;
    overflow: hidden;
  }

  #launch-btn::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(180deg, rgba(255,255,255,0.15) 0%, transparent 50%);
  }

  #launch-btn:hover {
    background: var(--gold);
    transform: translateY(-2px);
    border-bottom-width: 6px;
  }

  #launch-btn:active {
    transform: translateY(2px);
    border-bottom-width: 2px;
  }

  #launch-btn:disabled {
    opacity: 0.3;
    cursor: not-allowed;
    transform: none;
  }

  /* ── TICKER ── */
  #ticker {
    background: var(--amber);
    padding: 5px 0;
    overflow: hidden;
    flex-shrink: 0;
    position: relative;
    z-index: 50;
  }

  #ticker-inner {
    display: inline-block;
    white-space: nowrap;
    animation: ticker 40s linear infinite;
    font-size: 0.6rem;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--void);
    font-weight: bold;
  }

  @keyframes ticker {
    0% { transform: translateX(100vw); }
    100% { transform: translateX(-100%); }
  }

  /* ── LOADING SCREEN ── */
  #loading-screen {
    position: fixed;
    inset: 0;
    background: var(--void);
    z-index: 500;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 16px;
    transition: opacity 0.6s ease;
  }

  #loading-screen.fade {
    opacity: 0;
    pointer-events: none;
  }

  #loading-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 2rem;
    letter-spacing: 8px;
    color: var(--amber);
  }

  #loading-msg {
    font-size: 0.6rem;
    letter-spacing: 3px;
    color: var(--bark);
    text-transform: uppercase;
    animation: blink 1s step-end infinite;
  }

  /* ── SCRAGGLE TOAST ── */
  #scraggle-toast {
    position: fixed;
    bottom: 40px;
    right: 16px;
    z-index: 200;
    display: flex;
    flex-direction: column;
    gap: 6px;
    pointer-events: none;
  }

  .scraggle-toast-item {
    background: var(--mud);
    border: 1px solid var(--bark);
    border-left: 3px solid var(--amber);
    padding: 6px 12px;
    font-size: 0.55rem;
    letter-spacing: 1px;
    color: var(--warm);
    animation: toast-in 0.3s ease, toast-out 0.4s ease 3s forwards;
    white-space: nowrap;
  }

  @keyframes toast-in {
    from { opacity: 0; transform: translateX(20px); }
    to   { opacity: 1; transform: translateX(0); }
  }

  @keyframes toast-out {
    from { opacity: 1; }
    to   { opacity: 0; pointer-events: none; }
  }

</style>
</head>
<body>

<div id="loading-screen">
  <div id="loading-title">FIXED POINT LOCAL</div>
  <div id="loading-msg">TUNING IN...</div>
</div>

<div id="hub-shell">

  <!-- Always present: signal bar -->
  <div id="signal-bar">
    <span><span class="dot"></span>FIXED POINT LOCAL — ON AIR</span>
    <span id="signal-time"></span>
  </div>

  <!-- HUD bar — shown when a score is running and wants it -->
  <div id="hud-bar">
    <span id="hud-score-name"></span>
    <div id="hud-scraggle-feed"></div>
    <button id="hud-eject" onclick="ejectScore()">⏏ EJECT</button>
  </div>

  <!-- Selection panel — collapses when a score launches -->
  <div id="selection-panel">
    <div id="stage">

      <div id="masthead">
        <div id="channel-tag">A catalog of small gods, strange objects, & forgotten places</div>
        <div id="title">FIXED POINT <span>LOCAL</span></div>
        <div id="subtitle">The Hall is open. The music is already playing.</div>
        <div id="status-line">
          <span><span class="dot"></span>BROADCASTING</span>
          <span id="neighborhood-status">READING REGISTRY...</span>
          <span id="entity-count"></span>
        </div>
      </div>

      <div id="columns">

        <div id="rack-section">
          <h2>— Select a Score —</h2>
          <div id="score-rack">

            <div class="score-card selected" data-score="hunter-encounter" data-url="scores/hunter-encounter/index.html" onclick="selectScore(this)">
              <div class="score-title">HUNTER ENCOUNTER</div>
              <div class="score-desc">A turn-based encounter. The field crew is already on location. Something from The Hall is waiting.</div>
              <div class="score-meta">
                <span class="score-tag">Combat</span>
                <span class="score-tag">Single Session</span>
                <span class="score-tag">All Neighborhoods</span>
              </div>
            </div>

            <div class="score-card" data-score="grimoire" data-url="scores/grimoire/index.html" onclick="selectScore(this)">
              <div class="score-title">THE GRIMOIRE</div>
              <div class="score-desc">The living catalog. Residents, visitors, affinities, portraits. The Hall's memory made browsable.</div>
              <div class="score-meta">
                <span class="score-tag">Catalog</span>
                <span class="score-tag">Persistent</span>
              </div>
            </div>

            <div class="score-card" data-score="critter-crank" data-url="scores/critter-crank/index.html" onclick="selectScore(this)">
              <div class="score-title">CRITTER CRANK</div>
              <div class="score-desc">Turn the handle. Something arrives. Keep what you find, return it to The Hall.</div>
              <div class="score-meta">
                <span class="score-tag">Generator</span>
                <span class="score-tag">Single Session</span>
              </div>
            </div>

            <div class="score-card soon" data-score="tending-field">
              <div class="score-title">THE TENDING FIELD</div>
              <div class="score-desc">A critter arrives. An entity is already there. You are not playing either of them.</div>
              <div class="score-meta">
                <span class="score-tag">Observation</span>
                <span class="score-tag">Coming Soon</span>
              </div>
            </div>

          </div>

          <div id="launch-section">
            <div id="context-summary">Select a Score to begin.</div>
            <button id="launch-btn" disabled onclick="launchScore()">PLAY</button>
          </div>
        </div>

        <div id="sidebar">

          <div class="sidebar-block">
            <h3>Neighborhoods</h3>
            <div id="neighborhood-list">
              <div id="neighborhoods-loading" style="padding:10px 12px;font-size:0.6rem;color:var(--bark);letter-spacing:2px;">READING REGISTRY...</div>
            </div>
          </div>

          <div class="sidebar-block">
            <h3>Themes</h3>
            <div id="theme-list">
              <div id="themes-loading" style="padding:10px 12px;font-size:0.6rem;color:var(--bark);letter-spacing:2px;">READING THEMES...</div>
            </div>
          </div>

          <div class="sidebar-block">
            <h3>On The Roster</h3>
            <div id="roster-preview">
              <div id="roster-loading">FETCHING RESIDENTS...</div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <!-- Score frame — hidden until a score launches -->
  <div id="score-area">
    <iframe id="score-frame" title="Score"></iframe>
  </div>

  <!-- Always present: ticker -->
  <div id="ticker">
    <span id="ticker-inner">★ FIXED POINT LOCAL — THE HALL IS OPEN ★ THREE NEIGHBORHOODS ACTIVE ★ ATTEND GENTLY ★</span>
  </div>

</div>

<!-- Scraggle toasts -->
<div id="scraggle-toast"></div>

<script>
// ============================================================
// CONFIGURATION
// ============================================================

const HALL_REPO   = "Ariliteth/the-hall";
const HALL_BRANCH = "main";
const RAW         = `https://raw.githubusercontent.com/${HALL_REPO}/${HALL_BRANCH}`;

const KNOWN_THEMES = [
  {
    slug: "kitchendom",
    name: "Kitchendom",
    desc: "Cuisine-world vocabulary. Marketeer voice. The table is set."
  },
];

// ============================================================
// STATE
// ============================================================

let registry            = null;
let selectedScore       = "hunter-encounter";
let selectedScoreUrl    = "scores/hunter-encounter/index.html";
let activeThemes        = new Set();
let activeNeighborhoods = new Set();
let scoreRunning        = false;

// ============================================================
// BOOT
// ============================================================

window.addEventListener('DOMContentLoaded', async () => {
  updateClock();
  setInterval(updateClock, 1000);

  // Listen for messages from score frames
  window.addEventListener('message', handleScoreMessage);

  // Poll Scraggles — even with no score running, the hub is listening
  setInterval(pollScraggles, 3000);

  try {
    registry = await fetchRegistry();
    renderNeighborhoods();
    renderThemes();
    renderRoster();
    updateTicker();
    updateContextSummary();
  } catch(e) {
    document.getElementById('neighborhoods-loading').textContent = 'SIGNAL LOST — OFFLINE MODE';
    document.getElementById('roster-loading').textContent = 'NO SIGNAL';
    renderThemes();
  }

  updateLaunchButton();

  setTimeout(() => {
    document.getElementById('loading-screen').classList.add('fade');
    setTimeout(() => document.getElementById('loading-screen').remove(), 700);
  }, 900);
});

// ============================================================
// POSTMESSAGE — scores talk to the hub here
// ============================================================
// A score can send any of these messages:
//
//   { type: "hub:minimize" }          — collapse selection, show hud bar
//   { type: "hub:listen" }            — collapse selection, hide hud bar (pure listening)
//   { type: "hub:restore" }           — show selection panel again
//   { type: "hub:scraggle", emoji, signal } — show a scraggle in the hud
//   { type: "hub:title", name }       — update hud score name
//
// Scores that send nothing get the default: selection collapses, hud bar visible.

function handleScoreMessage(e) {
  // Only trust messages from our own origin
  if (e.origin !== window.location.origin) return;
  const msg = e.data;
  if (!msg || !msg.type) return;

  switch(msg.type) {
    case 'hub:minimize':
      setHubMode('hud');
      break;
    case 'hub:listen':
      setHubMode('listening');
      break;
    case 'hub:restore':
      setHubMode('selection');
      break;
    case 'hub:title':
      if (msg.name) document.getElementById('hud-score-name').textContent = msg.name;
      break;
    case 'hub:scraggle':
      receiveScraggle(msg.emoji || '✦', msg.signal || '');
      break;
  }
}

// ============================================================
// HUB MODES
// ============================================================

function setHubMode(mode) {
  const panel    = document.getElementById('selection-panel');
  const scoreArea = document.getElementById('score-area');
  const hudBar   = document.getElementById('hud-bar');

  switch(mode) {
    case 'hud':
      // Score running, hud bar visible, selection hidden
      panel.classList.add('collapsed');
      scoreArea.classList.add('active');
      hudBar.classList.add('visible');
      break;
    case 'listening':
      // Score running, hub invisible (just ticker + signal bar)
      panel.classList.add('collapsed');
      scoreArea.classList.add('active');
      hudBar.classList.remove('visible');
      break;
    case 'selection':
      // Back to selection screen
      panel.classList.remove('collapsed');
      scoreArea.classList.remove('active');
      hudBar.classList.remove('visible');
      scoreRunning = false;
      document.getElementById('score-frame').src = '';
      break;
  }
}

// ============================================================
// SCRAGGLE HANDLING
// ============================================================

// Poll localStorage for new Scraggles and show them as toasts
let lastScraggleCount = 0;

function pollScraggles() {
  try {
    const raw = localStorage.getItem('baseline-session/scraggles');
    if (!raw) return;
    const scraggles = JSON.parse(raw);
    if (!scraggles || scraggles.length <= lastScraggleCount) return;

    // Show new ones
    const newOnes = scraggles.slice(lastScraggleCount);
    newOnes.forEach(s => receiveScraggle(s.emoji, s.signal, false));
    lastScraggleCount = scraggles.length;
  } catch(e) {}
}

function receiveScraggle(emoji, signal, writeToStorage = true) {
  // Show in hud feed if hud bar is visible
  const feed = document.getElementById('hud-scraggle-feed');
  const hudVisible = document.getElementById('hud-bar').classList.contains('visible');
  if (hudVisible) {
    const el = document.createElement('span');
    el.className = 'hud-scraggle';
    el.textContent = emoji;
    el.title = signal;
    feed.appendChild(el);
    // Keep feed tidy — max 8 scraggles visible
    while (feed.children.length > 8) feed.removeChild(feed.firstChild);
  }

  // Show as toast regardless
  showScraggleToast(emoji, signal);

  // Write to storage if it came from outside (postMessage)
  if (writeToStorage) {
    try {
      const raw = localStorage.getItem('baseline-session/scraggles');
      const scraggles = raw ? JSON.parse(raw) : [];
      scraggles.push({ emoji, signal, source: 'hub', arrivedAt: Date.now() });
      localStorage.setItem('baseline-session/scraggles', JSON.stringify(scraggles));
      lastScraggleCount = scraggles.length;
    } catch(e) {}
  }
}

function showScraggleToast(emoji, signal) {
  const container = document.getElementById('scraggle-toast');
  const el = document.createElement('div');
  el.className = 'scraggle-toast-item';
  el.textContent = `${emoji} ${signal}`;
  container.appendChild(el);
  setTimeout(() => { if (el.parentNode) el.parentNode.removeChild(el); }, 4000);
}

// ============================================================
// REGISTRY
// ============================================================

async function fetchRegistry() {
  const res = await fetch(`${RAW}/registry.json`);
  if (!res.ok) throw new Error('Registry unavailable');
  return res.json();
}

// ============================================================
// RENDER NEIGHBORHOODS
// ============================================================

function renderNeighborhoods() {
  const container = document.getElementById('neighborhood-list');
  container.innerHTML = '';

  const neighborhoods = Object.entries(registry.neighborhoods);
  neighborhoods.forEach(([slug]) => activeNeighborhoods.add(slug));

  const getEntities = (entry) => Array.isArray(entry) ? entry : (entry.entities || []);
  const totalResidents = neighborhoods.reduce((sum, [, entry]) => sum + getEntities(entry).length, 0);

  document.getElementById('neighborhood-status').textContent = `${neighborhoods.length} NEIGHBORHOODS`;
  document.getElementById('entity-count').textContent = `${totalResidents} RESIDENTS`;

  neighborhoods.forEach(([slug, entry]) => {
    const entities = getEntities(entry);
    const hasTheme = !Array.isArray(entry) && entry.theme;
    const item = document.createElement('div');
    item.className = 'neighborhood-item';
    item.innerHTML = `
      <input type="checkbox" id="hood-${slug}" checked onchange="toggleNeighborhood('${slug}', this.checked)">
      <label class="neighborhood-name" for="hood-${slug}">${formatNeighborhoodName(slug)}${hasTheme ? ' ◆' : ''}</label>
      <span class="neighborhood-count">${entities.length}</span>
    `;
    container.appendChild(item);
  });
}

function formatNeighborhoodName(slug) {
  const names = {
    greengarden: 'Greengarden',
    kitchendom: 'The Kitchendom',
    mucklerbuckler: 'Mucklerbuckler',
  };
  return names[slug] || slug.replace(/-/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
}

function toggleNeighborhood(slug, checked) {
  if (checked) activeNeighborhoods.add(slug);
  else activeNeighborhoods.delete(slug);
  renderRoster();
  updateContextSummary();
  updateLaunchButton();
}

// ============================================================
// RENDER THEMES
// ============================================================

function renderThemes() {
  const container = document.getElementById('theme-list');
  container.innerHTML = '';

  const themes = [];
  if (registry) {
    for (const [slug, entry] of Object.entries(registry.neighborhoods)) {
      if (!Array.isArray(entry) && entry.theme) {
        themes.push({ slug: entry.theme, name: formatNeighborhoodName(slug), desc: `The ${formatNeighborhoodName(slug)} conducts.` });
      }
    }
  }
  KNOWN_THEMES.forEach(t => { if (!themes.find(x => x.slug === t.slug)) themes.push(t); });

  if (themes.length === 0) {
    container.innerHTML = '<div style="padding:10px 12px;font-size:0.6rem;color:var(--bark);letter-spacing:1px;">No themes in the repository yet.</div>';
    return;
  }

  themes.forEach(theme => {
    const item = document.createElement('div');
    item.className = 'theme-item';
    item.innerHTML = `
      <input type="checkbox" id="theme-${theme.slug}" onchange="toggleTheme('${theme.slug}', this.checked)">
      <div class="theme-info">
        <div class="theme-name">${theme.name}</div>
        <div class="theme-desc">${theme.desc}</div>
      </div>
    `;
    container.appendChild(item);
  });
}

function toggleTheme(slug, checked) {
  if (checked) activeThemes.add(slug);
  else activeThemes.delete(slug);
  updateContextSummary();
}

// ============================================================
// RENDER ROSTER
// ============================================================

function renderRoster() {
  const container = document.getElementById('roster-preview');
  container.innerHTML = '';
  if (!registry) return;

  const getEntities = (entry) => Array.isArray(entry) ? entry : (entry.entities || []);
  let any = false;

  for (const [hood, entry] of Object.entries(registry.neighborhoods)) {
    if (!activeNeighborhoods.has(hood)) continue;
    getEntities(entry).forEach(slug => {
      any = true;
      const el = document.createElement('div');
      el.className = 'roster-entry';
      el.innerHTML = `<span>${formatSlug(slug)}</span><span class="hood">${formatNeighborhoodName(hood)}</span>`;
      container.appendChild(el);
    });
  }

  if (!any) {
    container.innerHTML = '<div style="font-size:0.6rem;color:var(--bark);letter-spacing:1px;">No neighborhoods selected.</div>';
  }
}

function formatSlug(slug) {
  return slug.replace(/-/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
}

// ============================================================
// SCORE SELECTION
// ============================================================

function selectScore(el) {
  document.querySelectorAll('.score-card').forEach(c => c.classList.remove('selected'));
  el.classList.add('selected');
  selectedScore    = el.dataset.score;
  selectedScoreUrl = el.dataset.url;
  updateContextSummary();
  updateLaunchButton();
}

// ============================================================
// CONTEXT SUMMARY
// ============================================================

function updateContextSummary() {
  const el = document.getElementById('context-summary');
  if (!selectedScore) { el.textContent = 'Select a Score to begin.'; return; }

  const hoods = [...activeNeighborhoods].map(formatNeighborhoodName).join(', ') || 'none';
  const themes = activeThemes.size > 0
    ? [...activeThemes].map(t => KNOWN_THEMES.find(x => x.slug === t)?.name || t).join(', ')
    : 'none';
  const getEntities = (entry) => Array.isArray(entry) ? entry : (entry.entities || []);
  const residents = registry
    ? Object.entries(registry.neighborhoods).filter(([h]) => activeNeighborhoods.has(h)).reduce((sum, [, entry]) => sum + getEntities(entry).length, 0)
    : '?';

  el.innerHTML = `SCORE: ${formatSlug(selectedScore)}<br>NEIGHBORHOODS: ${hoods}<br>RESIDENTS ON ROSTER: ${residents}<br>THEMES: ${themes}`;
}

// ============================================================
// LAUNCH
// ============================================================

function updateLaunchButton() {
  const btn = document.getElementById('launch-btn');
  btn.disabled = !selectedScore || activeNeighborhoods.size === 0;
}

function launchScore() {
  if (!selectedScore || activeNeighborhoods.size === 0) return;

  const params = new URLSearchParams();
  params.set('neighborhoods', [...activeNeighborhoods].join(','));
  if (activeThemes.size > 0) params.set('themes', [...activeThemes].join(','));

  const url = `${selectedScoreUrl}?${params.toString()}`;

  // Load into the frame — stay on this page
  const frame = document.getElementById('score-frame');
  frame.src = url;
  scoreRunning = true;

  // Update hud name
  document.getElementById('hud-score-name').textContent = formatSlug(selectedScore);

  // Default mode: hud bar visible, selection collapses
  // The score can override this via postMessage once it loads
  setHubMode('hud');
}

function ejectScore() {
  setHubMode('selection');
}

// ============================================================
// TICKER
// ============================================================

function updateTicker() {
  if (!registry) return;
  const getEntities = (entry) => Array.isArray(entry) ? entry : (entry.entities || []);
  const hoods = Object.keys(registry.neighborhoods).map(formatNeighborhoodName);
  const residents = Object.values(registry.neighborhoods).flatMap(getEntities).map(formatSlug);
  const lines = [
    `★ FIXED POINT LOCAL — THE HALL IS OPEN`,
    `★ ${hoods.length} NEIGHBORHOODS BROADCASTING: ${hoods.join(' · ')}`,
    `★ RESIDENTS ON RECORD: ${residents.join(' · ')}`,
    `★ ATTEND GENTLY`,
    `★ CHAOS, LAUGHTER, JUSTICE`,
    `★ THE WORLD KNOWS MORE THAN IT SHOWS`,
    `★ CONSENT OVER COMMAND`,
    `★ NOTHING IS FORCED TO PARTICIPATE`,
    `★ FIXEDPOINTLOCAL — SIGNAL STRONG`,
  ];
  document.getElementById('ticker-inner').textContent = lines.join('   ');
}

// ============================================================
// CLOCK
// ============================================================

function updateClock() {
  const now = new Date();
  const t = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
  const el = document.getElementById('signal-time');
  if (el) el.textContent = t;
}

</script>
</body>
</html>
